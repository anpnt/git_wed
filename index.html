<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thiệp Cưới An Pham & Nhi Pham</title>
    <!-- Google Fonts cho typography đẹp -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600&family=Great+Vibes&family=Montserrat:wght@300;400&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background-color: #f0f2f5;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            font-family: 'Montserrat', sans-serif;
            overflow: hidden; /* Ngăn cuộn khi animation chạy */
        }

        .container {
            position: relative;
            width: 100%;
            max-width: 600px;
            height: 80vh; /* Chiều cao hiển thị */
            max-height: 850px;
            display: flex;
            justify-content: center;
            align-items: center;
            perspective: 1000px;
        }

        canvas {
            box-shadow: 0 20px 50px rgba(0,0,0,0.15);
            border-radius: 8px;
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            transition: transform 0.5s ease;
        }

        /* Nút bấm nổi */
        .interaction-overlay {
            position: absolute;
            bottom: 30px;
            z-index: 50;
            display: flex;
            flex-direction: column;
            gap: 10px;
            align-items: center;
            transition: opacity 0.5s;
        }

        .btn-wedding {
            background-color: #B8860B; /* Dark Golden Rod */
            color: white;
            padding: 10px 24px; 
            border-radius: 30px;
            font-family: 'Cinzel', serif;
            font-size: 14px; 
            font-weight: 600;
            border: 1px solid #DAA520;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(184, 134, 11, 0.3);
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-wedding:hover {
            background-color: #DAA520;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(184, 134, 11, 0.4);
        }
        
        .btn-secondary {
            background-color: transparent;
            color: #555;
            font-size: 12px;
            border: 1px solid #ccc;
            padding: 8px 16px;
            border-radius: 20px;
        }
        .btn-secondary:hover {
            background-color: #fff;
        }

        /* Loading font workaround */
        .font-loader {
            position: absolute;
            opacity: 0;
            pointer-events: none;
        }
    </style>
</head>
<body>

    <!-- Preload fonts to ensure canvas draws correctly -->
    <div class="font-loader">
        <span style="font-family: 'Great Vibes'">Load Script</span>
        <span style="font-family: 'Cinzel'">Load Serif</span>
        <span style="font-family: 'Montserrat'">Load Sans</span>
    </div>

    <!-- ÂM NHẠC: Thay link src bên dưới bằng link file mp3 Beautiful in White của bạn -->
    <!-- Hiện tại đang dùng một bản Piano lãng mạn mẫu (Royalty Free) -->
    <audio id="weddingMusic" loop>
        <source src="https://raw.githubusercontent.com/anpnt/git_wed/dev/442fca343815beee.mp3" type="audio/mpeg">
        Trình duyệt của bạn không hỗ trợ phát nhạc.
    </audio>

    <div class="container" id="cardContainer">
        <canvas id="weddingCanvas"></canvas>
        
        <div class="interaction-overlay" id="controls">
            <button class="btn-wedding" id="openBtn" onclick="openInvitation()">MỞ THIỆP</button>
            <button class="btn-wedding hidden" id="downloadBtn" onclick="downloadCard()">TẢI THIỆP</button>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('weddingCanvas');
        const ctx = canvas.getContext('2d');
        
        // Cấu hình kích thước 2K (Portrait)
        const REAL_WIDTH = 2048; 
        const REAL_HEIGHT = 2732; 
        
        // Thiết lập kích thước thực cho canvas
        canvas.width = REAL_WIDTH;
        canvas.height = REAL_HEIGHT;
        
        // State
        let isOpened = false;
        let animationFrame = 0;
        let coverOpacity = 1;
        let contentY = 100; 
        let hearts = []; 
        let fallingHearts = []; 
        let isRainingHearts = false; 

        // Màu sắc chủ đạo
        const COLORS = {
            bg: '#FDFBF7', 
            gold: '#C5A059', 
            darkText: '#2C2C2C',
            accent: '#E6D2B5', 
            envelope: '#FADADD', // Đổi màu nền phong bì sang Hồng Pastel (Pale Pink)
            envelopeDark: '#E5B3BB', // Màu tối hơn cho nếp gấp
            envelopeLight: '#FCE6EE', // Màu sáng hơn
            heartRed: '#8B0000', 
            heartGold: '#DAA520',
            heartPink: '#E8ADAA' 
        };

        // Hàm vẽ khung viền hoa văn
        function drawBorder(ctx) {
            const padding = 80;
            ctx.strokeStyle = COLORS.gold;
            ctx.lineWidth = 5;
            
            // Viền đôi
            ctx.strokeRect(padding, padding, REAL_WIDTH - padding*2, REAL_HEIGHT - padding*2);
            
            ctx.lineWidth = 2;
            ctx.strokeRect(padding + 20, padding + 20, REAL_WIDTH - padding*2 - 40, REAL_HEIGHT - padding*2 - 40);

            // Góc trang trí
            const cornerSize = 150;
            ctx.beginPath();
            // Góc trên trái
            ctx.moveTo(padding, padding + cornerSize);
            ctx.lineTo(padding, padding);
            ctx.lineTo(padding + cornerSize, padding);
            // Góc trên phải
            ctx.moveTo(REAL_WIDTH - padding - cornerSize, padding);
            ctx.lineTo(REAL_WIDTH - padding, padding);
            ctx.lineTo(REAL_WIDTH - padding, padding + cornerSize);
            // Góc dưới trái
            ctx.moveTo(padding, REAL_HEIGHT - padding - cornerSize);
            ctx.lineTo(padding, REAL_HEIGHT - padding);
            ctx.lineTo(padding + cornerSize, REAL_HEIGHT - padding);
            // Góc dưới phải
            ctx.moveTo(REAL_WIDTH - padding - cornerSize, REAL_HEIGHT - padding);
            ctx.lineTo(REAL_WIDTH - padding, REAL_HEIGHT - padding);
            ctx.lineTo(REAL_WIDTH - padding, REAL_HEIGHT - padding - cornerSize);
            
            ctx.lineWidth = 15;
            ctx.stroke();
        }

        // Hàm vẽ hoa lá cách điệu (Procedural)
        function drawFlourish(ctx, x, y, scale, rotation) {
            ctx.save();
            ctx.translate(x, y);
            ctx.scale(scale, scale);
            ctx.rotate(rotation);
            ctx.fillStyle = COLORS.gold;
            
            // Vẽ lá đơn giản bằng curves
            ctx.beginPath();
            ctx.moveTo(0, 0);
            ctx.bezierCurveTo(20, -20, 50, -10, 60, 0);
            ctx.bezierCurveTo(50, 10, 20, 20, 0, 0);
            ctx.fill();

            // Nhánh phụ
            ctx.beginPath();
            ctx.moveTo(0,0);
            ctx.rotate(0.5);
            ctx.bezierCurveTo(15, -15, 35, -5, 40, 0);
            ctx.bezierCurveTo(35, 5, 15, 15, 0, 0);
            ctx.fill();
            
            ctx.restore();
        }

        // --- HIỆU ỨNG TRÁI TIM ---
        function createHeart() {
            return {
                x: REAL_WIDTH / 2,
                y: REAL_HEIGHT * 0.45, 
                size: Math.random() * 40 + 20, 
                speedY: Math.random() * 15 + 5, 
                speedX: (Math.random() - 0.5) * 15, 
                opacity: 1,
                rotation: (Math.random() - 0.5) * 0.5,
                color: Math.random() > 0.6 ? COLORS.heartRed : COLORS.heartGold 
            };
        }

        function spawnHearts() {
            for(let i = 0; i < 60; i++) { 
                hearts.push(createHeart());
            }
        }

        function drawHeartShape(ctx, x, y, size, color, opacity, rotation) {
            ctx.save();
            ctx.globalAlpha = opacity;
            ctx.fillStyle = color;
            ctx.translate(x, y);
            ctx.rotate(rotation);
            ctx.beginPath();
            ctx.moveTo(0, -size/2); 
            ctx.bezierCurveTo(-size/2, -size, -size, -size/3, 0, size);
            ctx.bezierCurveTo(size, -size/3, size/2, -size, 0, -size/2);
            ctx.fill();
            ctx.restore();
        }

        function updateAndDrawHearts() {
            for (let i = 0; i < hearts.length; i++) {
                let h = hearts[i];
                drawHeartShape(ctx, h.x, h.y, h.size, h.color, h.opacity, h.rotation);
                h.y -= h.speedY; 
                h.x += h.speedX; 
                h.opacity -= 0.015; 
                h.rotation += 0.02; 
            }
            hearts = hearts.filter(h => h.opacity > 0);
        }

        // --- HIỆU ỨNG MƯA TRÁI TIM ---
        
        function createFallingHeart() {
            const colors = [COLORS.heartRed, COLORS.heartGold, COLORS.heartPink];
            return {
                x: Math.random() * REAL_WIDTH,
                y: -50, // Bắt đầu từ trên cao hơn màn hình
                size: Math.random() * 25 + 10, // Kích thước đa dạng
                speedY: Math.random() * 3 + 1.5, // Tốc độ rơi
                speedX: (Math.random() - 0.5) * 3, // Gió nhẹ
                opacity: Math.random() * 0.5 + 0.3, // Độ mờ
                rotation: Math.random() * Math.PI * 2,
                rotationSpeed: (Math.random() - 0.5) * 0.05, // Tự xoay khi rơi
                color: colors[Math.floor(Math.random() * colors.length)]
            };
        }

        function updateAndDrawFallingHearts() {
            if (fallingHearts.length < 150 && Math.random() < 0.3) { 
                fallingHearts.push(createFallingHeart());
            }

            for (let i = 0; i < fallingHearts.length; i++) {
                let h = fallingHearts[i];
                drawHeartShape(ctx, h.x, h.y, h.size, h.color, h.opacity, h.rotation);
                h.y += h.speedY;
                h.x += Math.sin(h.y * 0.01) + h.speedX; 
                h.rotation += h.rotationSpeed; 

                if (h.y > REAL_HEIGHT + 50) {
                    h.y = -50;
                    h.x = Math.random() * REAL_WIDTH;
                }
            }
        }

        // Vẽ nội dung thiệp
        function drawCardContent() {
            // Nền
            ctx.fillStyle = COLORS.bg;
            ctx.fillRect(0, 0, REAL_WIDTH, REAL_HEIGHT);

            // Họa tiết nền mờ
            ctx.globalAlpha = 0.03;
            ctx.fillStyle = "#000";
            for(let i=0; i<REAL_WIDTH; i+=40) ctx.fillRect(i, 0, 1, REAL_HEIGHT);
            for(let i=0; i<REAL_HEIGHT; i+=40) ctx.fillRect(0, i, REAL_WIDTH, 1);
            ctx.globalAlpha = 1.0;

            // Viền
            drawBorder(ctx);

            // Trang trí 4 góc
            drawFlourish(ctx, 120, 120, 2, Math.PI / 4 * 3);
            drawFlourish(ctx, REAL_WIDTH - 120, 120, 2, Math.PI / 4 * 1);
            drawFlourish(ctx, 120, REAL_HEIGHT - 120, 2, Math.PI / 4 * 5);
            drawFlourish(ctx, REAL_WIDTH - 120, REAL_HEIGHT - 120, 2, Math.PI / 4 * 7);

            // TEXT CONTENT
            ctx.textAlign = 'center';
            ctx.fillStyle = COLORS.darkText;

            // Save the date
            ctx.font = '400 60px "Cinzel"';
            ctx.fillStyle = COLORS.gold;
            ctx.fillText('SAVE THE DATE', REAL_WIDTH / 2, 500);

            // Lời mời
            ctx.font = '300 50px "Montserrat"';
            ctx.fillStyle = '#666';
            ctx.fillText('Trân trọng báo tin vui lễ thành hôn của', REAL_WIDTH / 2, 650);

            // TÊN CÔ DÂU CHÚ RỂ
            ctx.font = '400 220px "Great Vibes"';
            ctx.fillStyle = COLORS.darkText;
            
            ctx.shadowColor = "rgba(0,0,0,0.1)";
            ctx.shadowBlur = 10;
            ctx.shadowOffsetX = 5;
            ctx.shadowOffsetY = 5;

            ctx.fillText('An Pham', REAL_WIDTH / 2, 950);
            
            ctx.font = '300 80px "Cinzel"';
            ctx.fillText('&', REAL_WIDTH / 2, 1100);
            
            ctx.font = '400 220px "Great Vibes"';
            ctx.fillText('Nhi Pham', REAL_WIDTH / 2, 1350);

            ctx.shadowColor = "transparent";

            // Đường kẻ ngang
            ctx.beginPath();
            ctx.moveTo(REAL_WIDTH/2 - 200, 1500);
            ctx.lineTo(REAL_WIDTH/2 + 200, 1500);
            ctx.strokeStyle = COLORS.gold;
            ctx.lineWidth = 3;
            ctx.stroke();

            // Ngày tháng
            ctx.font = '600 50px "Montserrat"';
            ctx.fillStyle = COLORS.gold;
            ctx.fillText('CHÚNG TÔI KẾT HÔN VÀO', REAL_WIDTH / 2, 1650);

            // Big Date
            ctx.font = '600 180px "Cinzel"';
            ctx.fillStyle = COLORS.darkText;
            ctx.fillText('06 . 06 . 2026', REAL_WIDTH / 2, 1850);
            
            ctx.font = '400 60px "Cinzel"';
            ctx.fillText('THỨ BẢY', REAL_WIDTH / 2, 1950);

            // Địa điểm
            ctx.font = 'italic 50px "Montserrat"';
            ctx.fillStyle = '#666';
            ctx.fillText('Tại tư gia & Trung tâm tiệc cưới', REAL_WIDTH / 2, 2200);
            ctx.fillText('Rất hân hạnh được đón tiếp', REAL_WIDTH / 2, 2300);
        }

        // Hàm vẽ họa tiết tim nền cho phong bì
        function drawEnvelopePattern(ctx) {
            ctx.save();
            ctx.fillStyle = 'rgba(255, 255, 255, 0.4)'; // Màu trắng mờ
            
            const spacing = 150; // Khoảng cách giữa các tim
            const offsetX = 75; // So le
            
            for (let y = 0; y < REAL_HEIGHT; y += spacing) {
                for (let x = 0; x < REAL_WIDTH; x += spacing) {
                    // Tạo hiệu ứng so le hàng chẵn/lẻ
                    let drawX = x;
                    if ((y / spacing) % 2 === 0) {
                        drawX += offsetX;
                    }
                    
                    // Vẽ tim nhỏ
                    ctx.save();
                    ctx.translate(drawX, y);
                    ctx.rotate(Math.PI / 4); // Xoay nhẹ nếu muốn, ở đây để mặc định xoay trong hàm drawHeartShape nếu cần, nhưng drawHeartShape của chúng ta đã có rotate
                    // Gọi hàm vẽ tim có sẵn (chỉnh size nhỏ)
                    // Lưu ý hàm drawHeartShape nhận tham số rotation, ta để 0
                    
                    // Ta vẽ thủ công lại 1 tim đơn giản ở đây để tối ưu hoặc dùng hàm có sẵn
                    // Dùng hàm có sẵn nhưng phải cẩn thận translate
                    
                    // Vẽ tim thủ công cho nhanh và nhẹ
                    ctx.beginPath();
                    const size = 15;
                    ctx.moveTo(0, -size/2); 
                    ctx.bezierCurveTo(-size/2, -size, -size, -size/3, 0, size);
                    ctx.bezierCurveTo(size, -size/3, size/2, -size, 0, -size/2);
                    ctx.fill();
                    
                    ctx.restore();
                }
            }
            ctx.restore();
        }

        // Vẽ phong bì
        function drawEnvelope() {
            if (coverOpacity <= 0) return;

            ctx.save();
            ctx.globalAlpha = coverOpacity;

            // 1. Vẽ nền tổng thể (để lấp kín các khe hở nếu có)
            ctx.fillStyle = COLORS.envelope;
            ctx.fillRect(0, 0, REAL_WIDTH, REAL_HEIGHT);
            
            // 2. Vẽ họa tiết trái tim chìm lên toàn bộ nền trước khi vẽ các nếp gấp
            drawEnvelopePattern(ctx);

            // 3. Vẽ các nếp gấp (Flaps) với các sắc độ hồng khác nhau để tạo khối
            
            // Nếp gấp trên (Top Flap) - Màu đậm hơn chút để tạo bóng đổ xuống
            ctx.beginPath();
            ctx.moveTo(0, 0);
            ctx.lineTo(REAL_WIDTH, 0);
            ctx.lineTo(REAL_WIDTH / 2, REAL_HEIGHT * 0.4);
            ctx.closePath();
            ctx.fillStyle = COLORS.envelopeDark; // Hồng đậm hơn
            ctx.fill();
            ctx.strokeStyle = '#fff';
            ctx.lineWidth = 2;
            ctx.stroke();

            // Nếp gấp dưới (Bottom Flap) - Màu trung tính
            ctx.beginPath();
            ctx.moveTo(0, REAL_HEIGHT);
            ctx.lineTo(REAL_WIDTH, REAL_HEIGHT);
            ctx.lineTo(REAL_WIDTH / 2, REAL_HEIGHT * 0.45);
            ctx.closePath();
            ctx.fillStyle = '#F2C6CF'; // Hồng sắc độ khác
            ctx.fill();
            ctx.stroke();

            // Nếp gấp trái (Left Flap) - Màu sáng
            ctx.beginPath();
            ctx.moveTo(0, 0);
            ctx.lineTo(0, REAL_HEIGHT);
            ctx.lineTo(REAL_WIDTH / 2, REAL_HEIGHT * 0.45);
            ctx.closePath();
            ctx.fillStyle = COLORS.envelopeLight; // Hồng nhạt
            ctx.fill();

            // Nếp gấp phải (Right Flap) - Màu sáng
            ctx.beginPath();
            ctx.moveTo(REAL_WIDTH, 0);
            ctx.lineTo(REAL_WIDTH, REAL_HEIGHT);
            ctx.lineTo(REAL_WIDTH / 2, REAL_HEIGHT * 0.45);
            ctx.closePath();
            ctx.fillStyle = COLORS.envelopeLight; // Hồng nhạt
            ctx.fill();

            // Con dấu sáp
            const cx = REAL_WIDTH / 2;
            const cy = REAL_HEIGHT * 0.45;
            const r = 120;

            ctx.beginPath();
            ctx.arc(cx, cy, r, 0, Math.PI * 2);
            ctx.fillStyle = '#8B0000'; 
            ctx.shadowColor = 'rgba(0,0,0,0.3)';
            ctx.shadowBlur = 20;
            ctx.fill();
            
            ctx.beginPath();
            ctx.arc(cx, cy, r - 20, 0, Math.PI * 2);
            ctx.strokeStyle = '#A52A2A';
            ctx.lineWidth = 5;
            ctx.stroke();

            ctx.font = 'bold 100px "Great Vibes"';
            ctx.fillStyle = '#D4AF37'; 
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.shadowColor = 'transparent';
            ctx.fillText('NA', cx, cy);

            ctx.restore();
        }

        // Vòng lặp vẽ chính
        function render() {
            ctx.clearRect(0, 0, REAL_WIDTH, REAL_HEIGHT);
            
            // 1. Vẽ thiệp bên trong
            drawCardContent();

            // 2. Vẽ Mưa Tim
            if (isRainingHearts) {
                updateAndDrawFallingHearts();
            }

            // 3. Vẽ phong bì
            drawEnvelope();
        }

        function openInvitation() {
            if (isOpened) return;
            isOpened = true;
            
            // --- PHÁT NHẠC ---
            const audio = document.getElementById('weddingMusic');
            // Cài đặt âm lượng vừa phải
            audio.volume = 0.5; 
            // Bắt lỗi nếu trình duyệt chặn autoplay (thường sẽ ok vì có click user)
            audio.play().catch(e => {
                console.log("Không thể phát nhạc tự động: ", e);
            });

            spawnHearts(); 

            const btn = document.getElementById('openBtn');
            const downloadBtn = document.getElementById('downloadBtn');
            
            btn.style.opacity = '0';
            setTimeout(() => {
                btn.classList.add('hidden');
                downloadBtn.classList.remove('hidden');
                downloadBtn.classList.add('flex');
            }, 500);

            function animate() {
                if (coverOpacity > 0) {
                    coverOpacity -= 0.015; 
                    if (coverOpacity < 0) coverOpacity = 0;
                } 
                
                if (coverOpacity < 0.2 && !isRainingHearts) {
                    isRainingHearts = true;
                }

                render(); 
                
                if (hearts.length > 0) {
                    updateAndDrawHearts();
                }

                requestAnimationFrame(animate);
            }
            animate();
        }

        function downloadCard() {
            const link = document.createElement('a');
            link.download = 'Thiep_Cuoi_An_Nhi_20260606.png';
            link.href = canvas.toDataURL('image/png', 1.0);
            link.click();
        }

        window.onload = function() {
            setTimeout(() => {
                render();
            }, 500); 
        };

        document.fonts.ready.then(function () {
           render();
        });

    </script>
</body>
</html>

